{% extends "base.html" %}
{% block content %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
        #map {
            height: 400px !important;
            width: 100% !important;
            border-radius: 8px;
        }
    </style>

    <div class="order-form-container">
        <div class="order-form-header">
            <h5 class="modal-title">Book Your Photography Session</h5>
        </div>
        <div class="order-form-body">
            <form method="POST" action="" id="order-form" novalidate>
                {{ form.hidden_tag() }}
                <div class="form-group mb-3">
                    {{ form.service_type.label(class="form-label") }}
                    {{ form.service_type(class="form-select", id="service_type") }}
                </div>
                <div id="wedding-package-section" style="display: none;">
                    <div class="form-group mb-3">
                        {{ form.wedding_package.label(class="form-label") }}
                        {{ form.wedding_package(class="form-select", id="wedding_package") }}
                    </div>
                </div>
                <div class="form-group mb-3">
                    {{ form.event_date.label(class="form-label") }}
                    {{ form.event_date(class="form-control", id="event-date-picker") }}
                </div>
                <div class="form-group mb-3">
                    {{ form.event_start_time.label(class="form-label") }}
                    {{ form.event_start_time(class="form-control", id="event-start-time-picker") }}
                </div>
                <div class="form-group mb-3">
                    {{ form.event_end_time.label(class="form-label") }}
                    {{ form.event_end_time(class="form-control", id="event-end-time-picker") }}
                </div>
                <div class="form-group mb-3">
                    {{ form.location.label(class="form-label") }}
                    {{ form.location(class="form-control", id="location-input", placeholder="Enter a location") }}
                    {% for error in form.location.errors %}
                        <span class="text-danger">{{ error }}</span>
                    {% endfor %}
                </div>
                <div class="form-group mb-3">
                    <label class="form-label">Select Location on Map:</label>
                    <div id="map" style="height: 400px; width: 100%; border-radius: 8px;"></div>
                    {{ form.latitude(id="latitude-input") }}
                    {% for error in form.latitude.errors %}
                        <span class="text-danger">{{ error }}</span>
                    {% endfor %}
                    {{ form.longitude(id="longitude-input") }}
                    {% for error in form.longitude.errors %}
                        <span class="text-danger">{{ error }}</span>
                    {% endfor %}
                </div>
                <div class="form-group mb-3">
                    {{ form.details.label(class="form-label") }}
                    {{ form.details(class="form-control", rows=5) }}
                </div>

                <div id="total-price-section">
                    <div class="form-group mb-3">
                        {{ form.total_price.label(class="form-label") }}
                        {{ form.total_price(class="form-control", type="number", step="0.01") }}
                        {% for error in form.total_price.errors %}
                            <span class="text-danger">{{ error }}</span>
                        {% endfor %}
                    </div>
                </div>

                <div class="d-grid">
                    {{ form.submit(class="btn btn-primary") }}
                </div>
            </form>
        </div>
    </div>

    <script>
        let map;
        let marker;
        let geocoder;
        let autocomplete;

        // Make initMap globally accessible
        window.initMap = async function() {
            console.log("initMap function called.");
            await google.maps.importLibrary("geocoding");
            geocoder = new google.maps.Geocoder();
            const initialLat = parseFloat(document.getElementById('latitude-input').value) || -6.2088; // Default to Jakarta
            const initialLng = parseFloat(document.getElementById('longitude-input').value) || 106.8456; // Default to Jakarta

            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: initialLat, lng: initialLng },
                zoom: 12,
            });

            marker = new google.maps.Marker({
                map: map,
                position: { lat: initialLat, lng: initialLng },
                draggable: true,
            });

            const locationInput = document.getElementById('location-input');

            const { PlaceAutocompleteElement } = await google.maps.importLibrary("places");

            const autocompleteElement = new PlaceAutocompleteElement({
                inputElement: locationInput,
            });

            autocompleteElement.addEventListener("gmp-placechange", () => {
                const place = autocompleteElement.place;
                if (!place.geometry) {
                    window.alert("No details available for input: '" + place.name + "'");
                    return;
                }

                if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                } else {
                    map.setCenter(place.geometry.location);
                    map.setZoom(17);
                }
                marker.position = place.geometry.location;
                document.getElementById('latitude-input').value = place.geometry.location.lat();
                document.getElementById('longitude-input').value = place.geometry.location.lng();
                document.getElementById('location-input').value = place.formatted_address;
            });

            map.addListener('click', function(event) {
                marker.setPosition(event.latLng);
                document.getElementById('latitude-input').value = event.latLng.lat();
                document.getElementById('longitude-input').value = event.latLng.lng();
                geocodeLatLng(event.latLng);
            });

            locationInput.addEventListener('change', function() {
                geocodeAddress(locationInput.value);
            });
        };

        function geocodeAddress(address) {
            geocoder.geocode({ 'address': address }, function(results, status) {
                if (status === 'OK') {
                    map.setCenter(results[0].geometry.location);
                    marker.setPosition(results[0].geometry.location);
                    document.getElementById('latitude-input').value = results[0].geometry.location.lat();
                    document.getElementById('longitude-input').value = results[0].geometry.location.lng();
                } else {
                    alert('Geocode was not successful for the following reason: ' + status);
                }
            });
        }

        function geocodeLatLng(latlng) {
            geocoder.geocode({ 'location': latlng }, function(results, status) {
                if (status === 'OK') {
                    if (results[0]) {
                        document.getElementById('location-input').value = results[0].formatted_address;
                    } else {
                        document.getElementById('location-input').value = 'Unknown location';
                    }
                } else {
                    document.getElementById('location-input').value = 'Error geocoding';
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            {% if form.errors %}
                let errorMessages = '';
                {% for field, errors in form.errors.items() %}
                    errorMessages += '{{ field }}: ' + '{{ errors|join(", ") }}\n';
                {% endfor %}
                alert('Form Submission Error:\n' + errorMessages);
            {% endif %}
            const serviceTypeSelect = document.getElementById('service_type');
            const weddingPackageSection = document.getElementById('wedding-package-section');
            const weddingPackageSelect = document.getElementById('wedding_package');
            const totalPriceSection = document.getElementById('total-price-section');
            const totalPriceInput = document.getElementById('total_price');

            function toggleWeddingPackageVisibility() {
                if (serviceTypeSelect.value === 'wedding') {
                    weddingPackageSection.style.display = 'block';
                    totalPriceSection.style.display = 'none';
                    totalPriceInput.disabled = true; // Disable the input
                } else {
                    weddingPackageSection.style.display = 'none';
                    totalPriceSection.style.display = 'block';
                    totalPriceInput.disabled = false; // Enable the input
                }
            }

            function updateTotalPriceForWeddingPackage() {
                const selectedPackageId = weddingPackageSelect.value;
                if (selectedPackageId && window.weddingPackages[selectedPackageId]) {
                    totalPriceInput.value = window.weddingPackages[selectedPackageId];
                } else {
                    totalPriceInput.value = '';
                }
            }

            toggleWeddingPackageVisibility();

            serviceTypeSelect.addEventListener('change', toggleWeddingPackageVisibility);
            

            const eventDatePicker = document.getElementById('event-date-picker');
            let unavailableDates = [];

            // Inject weddingPackages data into JavaScript
            window.weddingPackages = {{ wedding_packages | tojson }};

            fetch('{{ url_for('main.unavailable_dates') }}')
                .then(response => response.json())
                .then(data => {
                    unavailableDates = data;
                    console.log('Unavailable dates:', unavailableDates);
                    initializeFlatpickr();
                })
                .catch(error => {
                    console.error('Error fetching unavailable dates:', error);
                    initializeFlatpickr();
                });

            function initializeFlatpickr() {
                flatpickr(eventDatePicker, {
                    dateFormat: "Y-m-d",
                    minDate: "today",
                    disable: [
                        function(date) {
                            const dateString = flatpickr.formatDate(date, "Y-m-d");
                            return unavailableDates.includes(dateString);
                        }
                    ],
                    onChange: function(selectedDates, dateStr, instance) {
                    }
                });

                flatpickr("#event-start-time-picker", {
                    enableTime: true,
                    noCalendar: true,
                    dateFormat: "H:i",
                    time_24hr: true
                });

                flatpickr("#event-end-time-picker", {
                    enableTime: true,
                    noCalendar: true,
                    dateFormat: "H:i",
                    time_24hr: true
                });
            }

            
        });
    </script>
{% endblock %}
