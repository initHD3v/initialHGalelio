{% extends "base.html" %}
{% block content %}
    <h1>Client Dashboard</h1>
    <p>Welcome, {{ current_user.username }}! <a href="{{ url_for('client.edit_profile_client') }}" class="btn btn-sm btn-outline-primary ms-2">Edit Profile</a></p>
    <h2>Your Orders</h2>
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center bg-light mb-3">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-list-alt"></i> Total Orders</h5>
                    <p class="card-text fs-3">{{ orders|length }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-info text-white mb-3">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-money-bill-wave"></i> Awaiting DP</h5>
                    <p class="card-text fs-3">{{ orders|selectattr('status', 'equalto', 'waiting_dp')|list|length }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-warning text-dark mb-3">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-hourglass-half"></i> Awaiting Approval</h5>
                    <p class="card-text fs-3">{{ orders|selectattr('status', 'equalto', 'waiting_approval')|list|length }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-success text-white mb-3">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-check-circle"></i> Accepted</h5>
                    <p class="card-text fs-3">{{ orders|selectattr('status', 'equalto', 'accepted')|list|length }}</p>
                </div>
            </div>
        </div>
    </div>

    <h2 class="mb-3">Your Orders</h2>
    <div class="row">
        {% if orders %}
            {% for order in orders %}
            <div class="col-md-6 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
                        <h5 class="mb-0 text-white">{{ order.service_type.capitalize() }}</h5>
                        <span class="badge rounded-pill {% if order.status == 'waiting_dp' %}bg-info{% elif order.status == 'waiting_approval' %}bg-warning text-dark{% elif order.status == 'accepted' %}bg-success{% elif order.status == 'rejected' %}bg-danger{% elif order.status == 'completed' %}bg-primary{% endif %}">
                            {{ order.status.capitalize().replace('Dp', 'DP').replace('Approval', 'Approval') }}
                        </span>
                    </div>
                    <div class="card-body">
                        <h6 class="card-subtitle mb-3 text-muted">Order ID: {{ order.id }}</h6>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex align-items-center"><i class="far fa-calendar-alt me-2 text-muted"></i> <strong>Date:</strong> <span class="ms-auto">{{ order.event_date.strftime('%Y-%m-%d') }}</span></li>
                            <li class="list-group-item d-flex align-items-center"><i class="far fa-clock me-2 text-muted"></i> <strong>Time:</strong> <span class="ms-auto">{{ order.event_start_time.strftime('%H:%M') }} - {{ order.event_end_time.strftime('%H:%M') }}</span></li>
                            <li class="list-group-item d-flex align-items-center"><i class="fas fa-map-marker-alt me-2 text-muted"></i> <strong>Location:</strong> <span class="ms-auto">{{ order.location }}</span></li>
                            <li class="list-group-item d-flex align-items-center"><i class="fas fa-dollar-sign me-2 text-muted"></i> <strong>Total Price:</strong> <span class="ms-auto">Rp {{ "{:,.2f}".format(order.total_price) }}</span></li>
                            {% if order.dp_paid > 0 %}
                            <li class="list-group-item d-flex align-items-center"><i class="fas fa-money-check-alt me-2 text-muted"></i> <strong>DP Paid:</strong> <span class="ms-auto">Rp {{ "{:,.2f}".format(order.dp_paid) }}</span></li>
                            {% endif %}
                            {% if order.status == 'accepted' %}
                            <li class="list-group-item d-flex align-items-center"><i class="fas fa-money-bill-alt me-2 text-muted"></i> <strong>Remaining Payment:</strong> <span class="ms-auto">Rp {{ "{:,.2f}".format(order.total_price - order.dp_paid) }}</span></li>
                            {% endif %}
                            {% if order.details %}
                            <li class="list-group-item"><i class="fas fa-align-left me-2 text-muted"></i> <strong>Details:</strong> {{ order.details }}</li>
                            {% endif %}
                        </ul>
                    </div>
                    <div class="card-footer bg-light border-top">
                        <div class="d-flex justify-content-end align-items-center">
                            {% if order.status == 'waiting_dp' %}
                                <a href="{{ url_for('client.dp_payment', order_id=order.id) }}" class="btn btn-sm btn-success"><i class="fas fa-money-bill-wave"></i> Pay DP (Rp {{ "{:,.2f}".format(order.total_price * 0.15) }})</a>
                            {% elif order.status == 'waiting_approval' %}
                                <span class="text-info me-2"><i class="fas fa-hourglass-start"></i> Awaiting Admin Approval</span>
                            {% elif order.status == 'completed' and order.can_submit_testimonial %}
                                {% set existing_testimonial = get_testimonial_for_order(order.id) %}
                                {% if existing_testimonial %}
                                    <span class="text-success me-2"><i class="fas fa-check-double"></i> Testimonial Submitted</span>
                                    {% if not existing_testimonial.is_approved %}
                                        <a href="{{ url_for('client.edit_testimonial_client', testimonial_id=existing_testimonial.id) }}" class="btn btn-sm btn-warning me-2"><i class="fas fa-edit"></i> Edit</a>
                                        <form action="{{ url_for('client.delete_testimonial_client', testimonial_id=existing_testimonial.id) }}" method="POST" style="display:inline;">
                                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this testimonial?');"><i class="fas fa-trash-alt"></i> Delete</button>
                                        </form>
                                    {% endif %}
                                {% else %}
                                    <a href="{{ url_for('client.submit_testimonial', order_id=order.id) }}" class="btn btn-sm btn-primary"><i class="fas fa-comment-dots"></i> Submit Testimonial</a>
                                {% endif %}
                            {% elif order.status == 'rejected' %}
                                <form action="{{ url_for('client.delete_order', order_id=order.id) }}" method="POST" style="display:inline;">
                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this rejected order?');"><i class="fas fa-trash-alt"></i> Delete Order</button>
                                </form>
                            {% elif order.status == 'cancelled' %}
                                <span class="text-danger me-2"><i class="fas fa-times-circle"></i> Order Cancelled (Payment Timeout)</span>
                                <a href="{{ url_for('main.order') }}" class="btn btn-sm btn-primary"><i class="fas fa-redo"></i> Order Again</a>
                            {% else %}
                                <span class="text-muted">No action available</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <p class="text-center text-muted">You have no orders yet.</p>
            </div>
        {% endif %}
{% endblock %}
